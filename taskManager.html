<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="webix/webix.css" type="text/css">
    <script src="webix/webix.js" type="text/javascript"></script>
    
    <link rel="stylesheet" href="style/style.css">
    <script src="javascript/object.js"></script>

    <title>Task manager</title>
</head>
<body>
    <script>
        function addProject() {
            webix.ui({
                view: 'popup',
                id: 'newProjects',
                position: 'center',
                body: {
                    view: 'form', 
                    id: 'newProject',
                    width: 300,
                    elements: [
                        { view: 'text', label: 'Проект', name: 'project', validate: webix.rules.isNotEmpty },
                        { view: 'text', label: 'Создан', labelWidth: 81, name: 'date', validate: webix.rules.isNumber },
                        { margin: 5, cols: [
                        { view: 'button', value: 'Создать' , minWidth: 65, css: 'webix_primary', click: addNewProject },
                        { view: 'button', value: 'Отмена', minWidth: 65, click: canselAddProject }
                    ]}
                ],
                on: {
                    onValidationError: function (key, obj) {
                        textMessage = 'Некорретно введена информация';
                        webix.message( { type:"error", text: textMessage } );
                        }
                    }
                }
            }).show();

            function addNewProject() {
                if ( $$('newProject').validate() ) {
                    let dataProject = $$('newProject').getValues(),
                        id;

                    for (let i = 0; i < activeProject.length; i++) {
                        if (dataProject.project == activeProject[i].project) {
                            webix.message('Такой проект уже существует');
                            return;
                        }
                    }

                    if (activeProject.length == 0) {
                        id = 1;
                    } else {
                        id = activeProject[activeProject.length - 1].id + 1;
                    }

                    dataProject.id = id;
                    dataProject.tasks = [];
                    activeProject.push(dataProject);
                    
                    $$('activeProject').add(dataProject);
                    webix.message('Новый проект создан');
                    $$('newProject').clear();
                    $$('newProjects').hide();
                }
            }

            function canselAddProject() {
                $$('newProject').clear();
                $$('newProjects').hide();
            }

        }

        
        function showProject(id) {
            let employeesInvolved = {},
                idActiveProject = $$('activeProject').getSelectedId().id,
                objTask = [],
                number;

            for (let i = 0; i < activeProject.length; i++) {
                if (activeProject[i].id == idActiveProject) {
                    if (activeProject[i].tasks.length == 0) {
                        number = 0;
                    } else {
                        let numberTask = activeProject[i].tasks;
                        number = numberTask[numberTask.length - 1].id;
                    }
                }
            }
            
            for (let i = 0; i < activeProject.length; i++) {
                if (activeProject[i].id == idActiveProject) {
                    objTask = activeProject[i].tasks;
                }
            }
            
            for (let i = 0; i < employees.length; i++) {
                employeesInvolved[employees[i].id] = `${employees[i].surname} ${employees[i].name}`;
            }

            function addTask() {
                ++number;
                $$('tasksProject').add({'id' : number});
            }

            // function deleteTask() {
            //     let index = $$('tasksProject').getSelectedId();
            //     $$('tasksProject').remove(index);
            // }

            function saveTasks() {
                for (let i = 0; i < activeProject.length; i++) {
                    if (activeProject[i].id == idActiveProject) {
                        activeProject[i].tasks = [];
                        let dataTasks = $$('tasksProject').data.pull;

                        for (let obj in dataTasks) {
                            activeProject[i].tasks.push(dataTasks[obj]);
                        }
                    }
                }
            }

            // function completeProject() {
            //     webix.confirm({
            //         title: 'Закрытие проекта',
            //         text: 'Уверены, что хотите завершить проект?'
            //     }).then( () => {

            //         for ( let i = 0; i < activeProject.length; i++ ) {
            //             if ( activeProject[i].id == idActiveProject ) {
            //                 let complProject = Object.assign({}, activeProject[i]);
            //                 complitedProjects.push(complProject);
            //                 activeProject.splice(i, 1);
            //             }
            //         }

            //         $$('activeProject').remove(idActiveProject);
            //         $$('editProject').hide();
            //         webix.message('Проект закрыт');
            //         console.log(activeProject)
            //     });
            // }

            function canselTasks() {
                $$('editProject').hide();
            }

            webix.ui({
                view: 'popup',
                id: 'editProject',
                position: 'center',
                body: {
                    rows: [
                        { view:"toolbar", elements:[
                            { view: 'button', value: 'Добавить задачу', click: addTask, minWidth: 65, css: 'webix_primary' },
                            //{ view: 'button', value: 'Удалить задачу', click: deleteTask, minWidth: 65, css: 'webix_primary' }
                        ]},

                        {
                        view: 'datatable',
                        id: 'tasksProject',
                        select: true,
                        width: 1150,
                        height: 450,
                        editable: true,
                        scroll: 'y',
                        autoConfig: true,
                        data: objTask,
                        columns: [
                            { id: 'id' },
                            { id: 'tasks', header: 'Задача', fillspace: true, editor: 'text' },
                            { id: 'designatedEmployee', header: 'Назначенный сотрудник', fillspace: true, editor: 'select', options: employeesInvolved },
                            { id: 'hours', header: 'Часы', fillspace: true, editor: 'text' },
                            { id: 'hoursSpent', header: 'Потраченные часы', fillspace: true, editor: 'text' },
                            { id: 'statusTask', header: 'Статус', fillspace: true, editor: 'select', options: massStatus },
                            //{ id:'', template: "<input class = 'delTask' type = 'button' value = 'Удалить задачу'>", fillspace: true},
                        ],
                        },
                        {
                            cols: [
                                { view: 'button', value: 'Сохранить' , click: saveTasks, minWidth: 65, css: 'webix_primary' , },
                                //{ view: 'button', value: 'Завершить проект' , click: completeProject, minWidth: 65, css: 'webix_primary' , },
                                { view: 'button', value: 'Закрыть' , click: canselTasks, minWidth: 65, css: 'webix_primary'  }
                            ]
                        }
                    ]
                }
            }).show();

            // $$('tasksProject').on_click.delTask = function(e, id) {
            //     $$('tasksProject').remove(id)
            //     webix.message('Задача удалена');
            // };
        }

        

        function deleteProject() {
            if ($$('activeProject').getSelectedId() !== undefined) {
            webix.confirm({
                    title: 'Проект будет удалён',
                    text: 'Уверены, что хотите удалить проект?'
                }).then( () => {
                    let dataProject = $$('activeProject').getSelectedId(),
                    idProject = dataProject.id;

                    for ( let i = 0; i < activeProject.length; i++ ) {
                        if ( activeProject[i].id == idProject ) {
                            let deletProject = Object.assign({}, activeProject[i]);
                            deletedProject.push(deletProject);
                            activeProject.splice(i, 1);
                        }
                    }

                    $$('activeProject').remove(idProject);
                    webix.message('Проект удалён');
                });
            }
        }

        function completedProject() {
            webix.ui({
                view: 'popup',
                id: 'completeProjects',
                position: 'center',
                body: {
                    rows: [
                        {
                        view: 'datatable',
                        id: 'completedProject',
                        scroll: 'y',
                        autoConfig: true,
                        data: complitedProjects,
                        columns: [
                            { id: 'project', header: 'Название проекта', fillspace: true },
                            { id: 'date', header: 'Дата создания', fillspace: true }
                        ],
                        },

                        {
                        view: 'button', 
                        id: 'canselWindowsCompletedProject', 
                        value: 'Закрыть', 
                        css: 'webix_primary', 
                        inputWidth: 300,
                        on: {
                            'onItemClick': function () {
                                $$('completeProjects').hide();
                                }
                            }
                        }
                    ]
                }
            }).show()
        }

        function addNewEmployee() {
            webix.ui({
            view: 'popup',
            id: 'newEmployees',
            position: 'center',
            body: {
                view: 'form', 
                id: 'newEmployee',
                width: 300,
                elements: [
                    { view: 'text', label: 'Фамилия', name: 'surname', validate: webix.rules.isNotEmpty },
                    { view: 'text', label: 'Имя', name: 'name', validate: webix.rules.isNotEmpty },
                    { view: 'text', label: 'Должность', labelWidth: 81, name: 'position', validate: webix.rules.isNotEmpty },
                    { margin: 5, cols: [
                    { view: 'button', value: 'Сохранить' , minWidth: 65, css: 'webix_primary', click: addEmployees},
                    { view: 'button', value: 'Отменить', minWidth: 65, click: canselEmployee }
                ]}
            ],
            on: {
                onValidationError: function (key, obj) {
                    textMessage = 'Некорретно введена информация';
                    webix.message( { type:"error", text: textMessage } );
                    }
                }
            }
            }).show();

            function addEmployees() {
                if ( $$('newEmployee').validate() ) {
                    let dataEmployee = $$('newEmployee').getValues(),
                        id;

                    for (let i = 0; i < employees.length; i++) {
                        if ( (employees[i].name == dataEmployee.name) && (employees[i].surname == dataEmployee.surname) ) {
                            webix.message('Такой сотрудник уже создан');
                            //$$('newEmployee').clear();
                            return;
                        }
                    }

                    if (employees.length == 0) {
                        id = 1;
                    } else {
                        id = employees[employees.length - 1].id + 1;
                    }

                    dataEmployee.id = id;
                    employees.push(dataEmployee);

                    $$('activeEmployees').add(dataEmployee);
                    webix.message('Сотрудник добавлен');
                    $$('newEmployee').clear();
                    $$('newEmployees').hide();
                }
            }

            function canselEmployee() {
                $$('newEmployee').clear();
                $$('newEmployees').hide();
            }
        }

        function showEmployeeCard(id) {
            webix.ui({
                view: 'popup',
                id: 'editEmployee',
                position: 'center',
                body: {
                    view: 'form', 
                    id: 'cardEmployee',
                    width: 330,
                    elements: [
                        { view: 'text', label: 'Фамилия', name: 'surname', validate: webix.rules.isNotEmpty },
                        { view: 'text', label: 'Имя', name: 'name', validate: webix.rules.isNotEmpty },
                        { view: 'text', label: 'Должность', labelWidth: 81, name: 'position', validate: webix.rules.isNotEmpty },
                        { margin: 5, cols: [
                        { view: 'button', value: 'Сохранить' , minWidth: 65, css: 'webix_primary', click: saveEmployee },
                        { view: 'button', value: 'Удалить сотрудника' , minWidth: 65, css: 'webix_primary', height: 45, click: deleteEmployees}
                    ]}
                ],
                    on: {
                        onValidationError: function (key, obj) {
                            textMessage = 'Некорретно введена информация';
                            webix.message( { type:"error", text: textMessage } );
                            }
                        }
                }
            }).show();

            let values = $$('activeEmployees').getItem(id);
            $$('cardEmployee').setValues(values);

                function deleteEmployees() {
                webix.confirm({
                    title: 'Сотрудник будет удалён',
                    text: 'Уверены, что хотите удалить сотрудника?'
                }).then( () => {
                    let dataEmployee = $$('cardEmployee').getValues();
                    idEmployee = dataEmployee.id;

                    for (let i = 0; i < employees.length; i++) {
                        if (employees[i].id == idEmployee) {
                            employees.splice(i, 1);
                        }
                    }

                    webix.message('Сотрудник удалён');
                    $$('activeEmployees').remove(id)
                    $$('cardEmployee').clear();
                    $$('editEmployee').hide();
                    
                })/*.finally( () => $$('editEmployee').hide())*/;
            }

            function saveEmployee() {
                if ($$('cardEmployee').validate()) {
                    let newValues = $$('cardEmployee').getValues();
                
                    $$('activeEmployees').updateItem(newValues.id, newValues);
                    $$('cardEmployee').clear();
                    $$('editEmployee').hide();
                }
            }             
        }
        

        let header = {
            cols: [
                { type: 'header', template: 'Task manager' },
                { view: 'button', id: 'regButton', value: 'Регистрация', autowidth: true },
                { view: 'button', id: 'autorizeButton', value: 'Авторизация', autowidth: true }
            ]
        };

        let menu = {
            view: 'list',
                id: 'menu',
                layout: 'x',
                select: true,
                width: 400,
                css: 'list_color',
                data: [
                    { id: 'projects', value: 'Проекты' },
                    { id: 'employees', value: 'Учёт сотрудников' }
                ],
                on: {
                    onAfterSelect: function(id) { 
                        $$(id).show();
                    }
                }
        };

        let activeProjects = {
            rows: [
            {
                cols: [
                    {
                        view: 'button', id: 'addButton', value: 'Добавить проект', autowidth: true, 
                        on: {
                            'onItemClick': addProject
                        }
                    },

                    {
                        view: 'button', id: 'delProject', value: 'Удалить проект', autowidth: true, 
                        on: {
                            'onItemClick': deleteProject
                        }
                    },

                    {
                        view: 'button', id: 'completeButton', value: 'Завершённые проекты', autowidth: true, 
                        on: {
                            'onItemClick': completedProject
                        }
                    }
                ]
            }, 
                {
                    view: 'datatable',
                    id: 'activeProject',
                    sort: 'multi',
                    scroll: 'y',
                    select: true,
                    autoConfig: true,
                    data: activeProject,
                    columns: [
                        { id: 'project', header: 'Название проекта', fillspace: true },
                        { id: 'date', header: 'Дата создания', fillspace: true }
                    ],
                    on: {
                        'onItemDblClick': showProject
                    }
                }
            ]
        };

        let activeEmployees = {
            rows: [
            {
                cols: [
                    {
                        view: 'button', id: 'addEmployees', value: 'Добавить сотрудника', autowidth: true,
                        on: {
                            'onItemClick': addNewEmployee
                        }
                    }
                ]
            }, 

                {
                view: 'datatable',
                id: 'activeEmployees',
                sort:'multi',
                scroll: 'y',
                select: true,
                columnWidth: 470,
                autoConfig: true,
                data: employees,
                columns: [
                    { id: 'surname', header: 'Фамилия', fillspace: true },
                    { id: 'name', header: 'Имя', fillspace: true },
                    { id: 'position', header: 'Должность', fillspace: true }
                ],
                on: {
                        'onItemDblClick': showEmployeeCard
                    }
                }
            ]
        };

        let multiview = {
            view: 'multiview',
            cells: [
                { id: 'projects', rows: [activeProjects] },
                { id: 'employees', rows: [activeEmployees] }
            ]
        };

        webix.ready(function() {
            webix.ui({
                css: 'allProject',
                rows:[
                    header,
                    menu,
                    multiview
                ]       
            });
        });
    </script>
</body>
</html>